<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ReelForge Spatial Audio Demo</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      background: #1a1a2e;
      color: #eee;
      font-family: 'Segoe UI', sans-serif;
      min-height: 100vh;
      overflow: hidden;
    }

    /* Slot game mockup */
    .slot-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
      height: 100vh;
    }

    /* Top bar */
    .top-bar {
      display: flex;
      justify-content: space-between;
      width: 100%;
      max-width: 900px;
      padding: 10px 20px;
      background: rgba(0, 0, 0, 0.4);
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .balance, .win-display {
      font-size: 18px;
      font-weight: bold;
    }

    .balance { color: #00ff88; }
    .win-display { color: #ffd700; }

    /* Reels area */
    .reels-area {
      display: flex;
      gap: 10px;
      background: rgba(0, 0, 0, 0.5);
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
    }

    .reel {
      width: 100px;
      height: 200px;
      background: linear-gradient(180deg, #2a2a4a 0%, #1a1a3a 100%);
      border: 2px solid #444;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 48px;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .reel:hover {
      transform: scale(1.02);
      box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
    }

    .reel.active {
      animation: reel-spin 0.1s linear infinite;
      box-shadow: 0 0 30px rgba(255, 100, 0, 0.5);
    }

    @keyframes reel-spin {
      0% { transform: translateY(-2px); }
      50% { transform: translateY(2px); }
      100% { transform: translateY(-2px); }
    }

    /* Controls */
    .controls {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
    }

    button {
      padding: 15px 30px;
      font-size: 16px;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: transform 0.1s, background 0.2s;
    }

    button:hover {
      transform: scale(1.05);
    }

    button:active {
      transform: scale(0.98);
    }

    .spin-btn {
      background: linear-gradient(180deg, #ff6600 0%, #cc4400 100%);
      color: white;
      min-width: 150px;
    }

    .spin-btn:disabled {
      background: #555;
      cursor: not-allowed;
    }

    .coin-btn {
      background: linear-gradient(180deg, #ffd700 0%, #cc9900 100%);
      color: #333;
    }

    .win-btn {
      background: linear-gradient(180deg, #00ff88 0%, #00cc66 100%);
      color: #333;
    }

    /* Progress slider */
    .progress-control {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      margin-top: 20px;
      padding: 20px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 8px;
      width: 100%;
      max-width: 500px;
    }

    .progress-control label {
      font-size: 14px;
      color: #888;
    }

    .progress-control input[type="range"] {
      width: 100%;
      height: 8px;
      -webkit-appearance: none;
      background: #333;
      border-radius: 4px;
      outline: none;
    }

    .progress-control input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 20px;
      height: 20px;
      background: #ffd700;
      border-radius: 50%;
      cursor: pointer;
    }

    .progress-value {
      font-family: monospace;
      font-size: 24px;
      color: #ffd700;
    }

    /* Coin animation element */
    .flying-coin {
      position: fixed;
      width: 40px;
      height: 40px;
      background: radial-gradient(circle at 30% 30%, #ffd700 0%, #cc9900 100%);
      border-radius: 50%;
      border: 2px solid #aa7700;
      display: none;
      z-index: 1000;
      pointer-events: none;
    }

    .flying-coin::after {
      content: '$';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 20px;
      font-weight: bold;
      color: #886600;
    }

    /* Instructions */
    .instructions {
      position: fixed;
      bottom: 60px;
      left: 20px;
      font-size: 12px;
      color: #666;
      max-width: 300px;
    }

    .instructions h4 {
      color: #888;
      margin-bottom: 8px;
    }

    .instructions ul {
      list-style: none;
    }

    .instructions li {
      margin-bottom: 4px;
    }

    .instructions li::before {
      content: '‚Ä¢';
      margin-right: 8px;
      color: #ff6600;
    }

    /* Audio status */
    .audio-status {
      position: fixed;
      top: 10px;
      right: 10px;
      padding: 8px 15px;
      background: rgba(0, 0, 0, 0.7);
      border-radius: 20px;
      font-size: 12px;
    }

    .audio-status.active {
      color: #00ff88;
    }

    .audio-status.inactive {
      color: #ff4444;
    }
  </style>
</head>
<body>
  <div class="slot-container">
    <!-- Top bar with anchors -->
    <div class="top-bar">
      <div class="balance" data-rf-anchor="balance_value">
        Balance: $1,000.00
      </div>
      <div class="win-display" data-rf-anchor="win_display">
        Win: $0.00
      </div>
    </div>

    <!-- Reels -->
    <div class="reels-area" data-rf-anchor="reels_center">
      <div class="reel" data-rf-anchor="reel_0">‚ö°</div>
      <div class="reel" data-rf-anchor="reel_1">üèõÔ∏è</div>
      <div class="reel" data-rf-anchor="reel_2">‚ö°</div>
      <div class="reel" data-rf-anchor="reel_3">üèõÔ∏è</div>
      <div class="reel" data-rf-anchor="reel_4">‚ö°</div>
    </div>

    <!-- Controls -->
    <div class="controls">
      <button class="spin-btn" data-rf-anchor="spin_button" onclick="triggerSpin()">
        SPIN
      </button>
      <button class="coin-btn" onclick="triggerCoinFly()">
        Coin Fly
      </button>
      <button class="win-btn" onclick="triggerBigWin()">
        Big Win
      </button>
    </div>

    <!-- Progress slider for coin animation -->
    <div class="progress-control">
      <label>Manual Coin Progress (drag to test spatial tracking)</label>
      <input type="range" id="progressSlider" min="0" max="100" value="0" oninput="updateCoinProgress(this.value)">
      <div class="progress-value" id="progressValue">0%</div>
    </div>
  </div>

  <!-- Flying coin element -->
  <div class="flying-coin" id="flyingCoin"></div>

  <!-- Instructions -->
  <div class="instructions">
    <h4>Controls</h4>
    <ul>
      <li>Click SPIN to trigger reel stops (left to right)</li>
      <li>Click Coin Fly for animated coin path</li>
      <li>Drag slider for manual spatial testing</li>
      <li>Click Big Win for centered celebration</li>
      <li>Click individual reels for stop sounds</li>
    </ul>
  </div>

  <!-- Audio status -->
  <div class="audio-status inactive" id="audioStatus">
    üîá Click to enable audio
  </div>

  <script type="module">
    // Import spatial system
    import {
      createSpatialEngine,
      createWebAudioAdapter,
      createDebugOverlay,
    } from '../index.ts';

    // Globals
    let engine;
    let audioAdapter;
    let debugOverlay;
    let audioCtx;
    let oscillators = new Map();

    // Initialize
    async function init() {
      // Create spatial engine
      engine = createSpatialEngine({
        debugOverlay: true,
        predictiveLeadMs: 20,
      });

      // Create debug overlay
      debugOverlay = createDebugOverlay({
        showVelocity: true,
        showConfidence: true,
        showPredicted: true,
        showPanMeter: true,
      });

      // Set debug callback
      engine.setDebugCallback((frame) => {
        debugOverlay.updateFrame(frame);
      });

      // Start engine and overlay
      engine.start();
      debugOverlay.start();

      // Setup audio on first interaction
      document.addEventListener('click', initAudio, { once: true });

      console.log('ReelForge Spatial Demo initialized');
    }

    // Initialize audio
    function initAudio() {
      audioCtx = new AudioContext();
      audioAdapter = createWebAudioAdapter(audioCtx, {
        rampTimeMs: 20,
        useChannelGains: true,
      });
      engine.setAudioAdapter(audioAdapter);

      document.getElementById('audioStatus').classList.remove('inactive');
      document.getElementById('audioStatus').classList.add('active');
      document.getElementById('audioStatus').textContent = 'üîä Audio active';
    }

    // Create simple oscillator for testing
    function createTestSound(voiceId, frequency = 440, duration = 500) {
      if (!audioCtx) return;

      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();

      osc.type = 'sine';
      osc.frequency.value = frequency;

      gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration / 1000);

      // Create voice in adapter
      audioAdapter.createVoice(voiceId, osc, audioCtx.destination);

      osc.connect(gain);
      gain.connect(audioAdapter.voices?.get(voiceId)?.pannerNode ?? audioCtx.destination);

      osc.start();
      osc.stop(audioCtx.currentTime + duration / 1000);

      oscillators.set(voiceId, { osc, gain });

      // Cleanup
      setTimeout(() => {
        audioAdapter.destroyVoice(voiceId);
        oscillators.delete(voiceId);
      }, duration + 100);
    }

    // Trigger spin (sequential reel stops)
    window.triggerSpin = async function() {
      const spinBtn = document.querySelector('.spin-btn');
      const reels = document.querySelectorAll('.reel');

      spinBtn.disabled = true;

      // Start spinning animation
      reels.forEach(r => r.classList.add('active'));

      // Stop reels sequentially
      for (let i = 0; i < 5; i++) {
        await new Promise(resolve => setTimeout(resolve, 300 + i * 150));

        reels[i].classList.remove('active');

        const voiceId = `reel_stop_${i}_${Date.now()}`;

        // Create sound
        createTestSound(voiceId, 200 + i * 50, 200);

        // Send spatial event
        engine.onEvent({
          id: voiceId,
          name: 'REEL_STOP',
          intent: `REEL_${i}_STOP`,
          bus: 'REELS',
          timeMs: performance.now(),
          anchorId: `reel_${i}`,
          voiceId,
          lifetimeMs: 400,
        });
      }

      spinBtn.disabled = false;
    };

    // Trigger coin fly animation
    window.triggerCoinFly = function() {
      const coin = document.getElementById('flyingCoin');
      const voiceId = `coin_${Date.now()}`;

      // Create continuous sound
      if (audioCtx) {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();

        osc.type = 'sawtooth';
        osc.frequency.value = 800;

        gain.gain.value = 0.15;

        audioAdapter.createVoice(voiceId, osc);
        osc.start();

        oscillators.set(voiceId, { osc, gain });
      }

      // Animate coin
      coin.style.display = 'block';
      let progress = 0;

      const animate = () => {
        if (progress >= 1) {
          coin.style.display = 'none';
          engine.removeEvent(voiceId);

          // Stop sound
          const sounds = oscillators.get(voiceId);
          if (sounds) {
            sounds.osc.stop();
            audioAdapter.destroyVoice(voiceId);
            oscillators.delete(voiceId);
          }
          return;
        }

        // Get anchor positions
        const reelsRect = document.querySelector('[data-rf-anchor="reels_center"]').getBoundingClientRect();
        const balanceRect = document.querySelector('[data-rf-anchor="balance_value"]').getBoundingClientRect();

        const startX = reelsRect.left + reelsRect.width / 2;
        const startY = reelsRect.top + reelsRect.height / 2;
        const endX = balanceRect.left + balanceRect.width / 2;
        const endY = balanceRect.top + balanceRect.height / 2;

        // Eased progress for arc motion
        const t = progress;
        const x = startX + (endX - startX) * t;
        const y = startY + (endY - startY) * t - Math.sin(t * Math.PI) * 100;

        coin.style.left = `${x - 20}px`;
        coin.style.top = `${y - 20}px`;

        // Send spatial event
        engine.onEvent({
          id: voiceId,
          name: 'COIN_FLY',
          intent: 'COIN_FLY_TO_BALANCE',
          bus: 'FX',
          timeMs: performance.now(),
          startAnchorId: 'reels_center',
          endAnchorId: 'balance_value',
          progress01: progress,
          voiceId,
          lifetimeMs: 1500,
        });

        progress += 0.02;
        requestAnimationFrame(animate);
      };

      animate();
    };

    // Manual coin progress control
    window.updateCoinProgress = function(value) {
      const progress = value / 100;
      document.getElementById('progressValue').textContent = `${value}%`;

      const coin = document.getElementById('flyingCoin');
      const reelsRect = document.querySelector('[data-rf-anchor="reels_center"]').getBoundingClientRect();
      const balanceRect = document.querySelector('[data-rf-anchor="balance_value"]').getBoundingClientRect();

      const startX = reelsRect.left + reelsRect.width / 2;
      const startY = reelsRect.top + reelsRect.height / 2;
      const endX = balanceRect.left + balanceRect.width / 2;
      const endY = balanceRect.top + balanceRect.height / 2;

      const t = progress;
      const x = startX + (endX - startX) * t;
      const y = startY + (endY - startY) * t - Math.sin(t * Math.PI) * 100;

      coin.style.display = progress > 0 ? 'block' : 'none';
      coin.style.left = `${x - 20}px`;
      coin.style.top = `${y - 20}px`;

      // Send spatial event
      if (progress > 0) {
        engine.onEvent({
          id: 'manual_coin',
          name: 'COIN_FLY',
          intent: 'COIN_FLY_TO_BALANCE',
          bus: 'FX',
          timeMs: performance.now(),
          startAnchorId: 'reels_center',
          endAnchorId: 'balance_value',
          progress01: progress,
          lifetimeMs: 5000,
        });
      } else {
        engine.removeEvent('manual_coin');
      }
    };

    // Trigger big win
    window.triggerBigWin = function() {
      const voiceId = `bigwin_${Date.now()}`;

      // Create fanfare sound
      if (audioCtx) {
        const osc1 = audioCtx.createOscillator();
        const osc2 = audioCtx.createOscillator();
        const gain = audioCtx.createGain();

        osc1.type = 'square';
        osc1.frequency.value = 523.25; // C5
        osc2.type = 'square';
        osc2.frequency.value = 659.25; // E5

        gain.gain.value = 0.15;

        osc1.connect(gain);
        osc2.connect(gain);

        audioAdapter.createVoice(voiceId, gain);
        osc1.start();
        osc2.start();

        // Simple melody
        setTimeout(() => osc1.frequency.value = 659.25, 200);
        setTimeout(() => osc2.frequency.value = 783.99, 200);
        setTimeout(() => osc1.frequency.value = 783.99, 400);
        setTimeout(() => osc2.frequency.value = 987.77, 400);

        setTimeout(() => {
          osc1.stop();
          osc2.stop();
          audioAdapter.destroyVoice(voiceId);
        }, 2000);
      }

      // Send spatial event (centered, wide)
      engine.onEvent({
        id: voiceId,
        name: 'BIG_WIN',
        intent: 'BIG_WIN',
        bus: 'FX',
        timeMs: performance.now(),
        anchorId: 'reels_center',
        voiceId,
        lifetimeMs: 3000,
      });

      // Flash win display
      const winDisplay = document.querySelector('.win-display');
      winDisplay.textContent = 'Win: $500.00';
      winDisplay.style.transform = 'scale(1.3)';
      winDisplay.style.transition = 'transform 0.3s';

      setTimeout(() => {
        winDisplay.style.transform = 'scale(1)';
      }, 300);
    };

    // Individual reel click
    document.querySelectorAll('.reel').forEach((reel, index) => {
      reel.addEventListener('click', () => {
        const voiceId = `reel_click_${index}_${Date.now()}`;

        createTestSound(voiceId, 300 + index * 80, 150);

        engine.onEvent({
          id: voiceId,
          name: 'REEL_CLICK',
          intent: `REEL_${index}_STOP`,
          bus: 'UI',
          timeMs: performance.now(),
          anchorId: `reel_${index}`,
          voiceId,
          lifetimeMs: 300,
        });
      });
    });

    // Initialize on load
    init();
  </script>
</body>
</html>
